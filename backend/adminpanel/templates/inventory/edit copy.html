<!-- edit.html -->
{% extends 'layouts/default.html' %}
{% load static %}
{% block content %}
<style>
    #dynamicForm {
        border: 2px solid #007bff; /* Change the color and width as needed */
        border-radius: 5px;        /* Optional: to make the corners rounded */
        padding: 15px;             /* Add some padding inside the border */
        margin-top: 10px;          /* Optional: add some margin at the top */
        background-color: #f9f9f9; /* Optional: to add a background color */
    }
    .dropzone .dz-preview .dz-remove {
        position: absolute;
        right: -5px;
        top: -5px;
        z-index: 99;
        background: #5867dd;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        border-radius: 10px;
        text-decoration: none !important;
        cursor: pointer;
    }
    .dz-filename{
        display: none;
    }
    .dz-size{
        margin-top: 22px;
    }
</style>
<link rel="stylesheet" href="{% static 'admin/css/dropzone.min.css' %}">
<div class="container-fluid">
    <div class="row">
        <div class="col-xl-12 box-margin">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="card-title mb-0">Edit Item</h6>
                        <div class="float-right mb-3">
                            <button type="submit" class="btn btn-primary" id="nextStep">Submit</button>
                            <a class="btn btn-primary waves-effect waves-light " href="">Go back</a>
                        </div>
                    </div>
                    <div class="alert alert-success FinalUpdate" role="alert" style="display: none;">                        
                    </div>
                    <ul class="nav nav-tabs nav-bordered">
                        <li class="nav-item">
                            <a href="#step1" data-toggle="tab" aria-expanded="false" class="nav-link active">
                                General Info
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#step2" data-toggle="tab" aria-expanded="false" class="nav-link">
                                Images
                            </a>
                        </li>
                    </ul>
                    <div class="step-1">
                        <form class="cmxform" id="commentForm" method="post" action="{% url 'editinventory' inventory_item.id %}" enctype="multipart/form-data">
                            {% csrf_token %}
                            <div class="tab-content">
                                <fieldset id="step1" class="tab-pane show active">
                                    <!-- General Info Form Content -->
                                    <div class="row">
                                        <!-- Category / Subcategory -->
                                        <div class="col-md-6 form-group">
                                            <label for="category">Category / Subcategory <span class="text-danger">*</span></label>
                                            <select id="category" class="form-control" name="category" onchange="updateFields()">
                                                <option value="" selected>Choose Category</option>
                                                {% for category in categories %}
                                                    {% if not category.parent %}
                                                        <optgroup label="{{ category.name }}">
                                                            {% for subcategory in categories %}
                                                                {% if subcategory.parent and subcategory.parent.id == category.id %}
                                                                    <option value="{{ subcategory.id }}" {% if form.category.value == subcategory.id %}selected{% endif %}>
                                                                        &nbsp;&nbsp;&nbsp;{{ subcategory.name }}
                                                                    </option>
                                                                {% endif %}
                                                            {% endfor %}
                                                        </optgroup>
                                                    {% endif %}
                                                {% endfor %}
                                            </select>
                                            <div class="text-danger" id="error_category"></div>
                                        </div>
            
                                        <!-- Title -->
                                        <div class="col-md-6 form-group">
                                            <label for="title">Title <span class="text-danger">*</span></label>
                                            <input id="title" class="form-control" name="title" type="text" placeholder="Type Title Name.." value="{{ form.title.value|default:'' }}">
                                            <div class="text-danger" id="error_title"></div>
                                        </div>
            
                                        <!-- Description -->
                                        <div class="col-md-12 form-group">
                                            <label for="description">Description <span class="text-danger">*</span></label>
                                            <textarea name="description" id="editor" placeholder="Add Description Here">{{ form.description.value|default:'' }}</textarea>
                                            <div class="text-danger" id="error_description"></div>
                                        </div>
            
                                        <!-- Status -->
                                        <div class="col-md-4 form-group">
                                            <label for="status">Status <span class="text-danger">*</span></label>
                                            <select id="status" class="form-control" name="status">
                                                <option value="">Select Status</option>
                                                <option value="pending" {% if form.status.value == 'pending' %}selected{% endif %}>Pending</option>
                                                <option value="in_transit" {% if form.status.value == 'in_transit' %}selected{% endif %}>In Transit</option>
                                                <option value="auction" {% if form.status.value == 'auction' %}selected{% endif %}>In Auction</option>
                                            </select>
                                            <div class="text-danger" id="error_status"></div>
                                        </div>
            
                                        <!-- In Transit Status -->
                                        <div class="col-md-4 form-group" id="inTransitStatusDiv" style="display:none;">
                                            <label for="in_transit_status">In Transit Status <span class="text-danger">*</span></label>
                                            <select id="in_transit_status" class="form-control" name="in_transit_status">
                                                <option value="">Select In Transit Status</option>
                                                <option value="awaiting_dispatch" {% if form.in_transit_status.value == 'awaiting_dispatch' %}selected{% endif %}>Awaiting Dispatch</option>
                                                <option value="awaiting_pickup" {% if form.in_transit_status.value == 'awaiting_pickup' %}selected{% endif %}>Awaiting Pick Up</option>
                                                <option value="awaiting_arrival" {% if form.in_transit_status.value == 'awaiting_arrival' %}selected{% endif %}>Awaiting Arrival</option>
                                            </select>
                                            <div class="text-danger" id="error_in_transit_status"></div>
                                        </div>
            
                                        <!-- Auction Name -->
                                        <div class="col-md-4 form-group auctionDiv" style="display:none;">
                                            <label for="auction">Auction Name <span class="text-danger">*</span></label>
                                            <select id="auction" class="form-control" name="auction">
                                                <option value="">Select Auction</option>
                                                {% for auction in upcoming_auctions %}
                                                    <option value="{{ auction.id }}" {% if inventory_item.auction and inventory_item.auction.id == auction.id %}selected{% endif %}>{{ auction.name }}</option>
                                                {% endfor %}
                                            </select>
                                            <div class="text-danger" id="error_auction"></div>
                                        </div>
                                        <!-- Condition -->
                                        <div class="col-md-4 form-group">
                                            <label for="condition">Condition <span class="text-danger">*</span></label>
                                            <select id="condition" class="form-control" name="condition">
                                                <option value="">Select Condition</option>
                                                <option value="new" {% if form.condition.value == 'new' %}selected{% endif %}>New</option>
                                                <option value="old" {% if form.condition.value == 'old' %}selected{% endif %}>Old</option>
                                            </select>
                                            <div class="text-danger" id="error_condition"></div>
                                        </div>
            
                                        <!-- Starting Bid Amount -->
                                        <div class="col-md-4 form-group">
                                            <label for="starting_bid">Starting Bid Amount <span class="text-danger">*</span></label>
                                            <select id="starting_bid" class="form-control" name="starting_bid">
                                                <option value="">Select Starting Bid</option>
                                                {% for amount in starting_bid_amounts %}
                                                    <option value="{{ amount }}" {% if form.starting_bid.value == amount %}selected{% endif %}>$ {{ amount }}</option>
                                                {% endfor %}
                                            </select>
                                            <div class="text-danger" id="error_starting_bid"></div>
                                        </div>
            
                                        <!-- Reserve Price -->
                                        <div class="col-md-4 form-group">
                                            <label for="reserve_price">Reserve Price <span class="text-danger">*</span></label>
                                            <div class="input-group">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text"><i class="fas fa-dollar-sign" aria-hidden="true"></i></span>
                                                </div>
                                                <input id="reserve_price" class="form-control" name="reserve_price" type="text" placeholder="Enter Reserve Price" min="50" value="{{ form.reserve_price.value|default:'' }}">
                                            </div>
                                            <div class="text-danger" id="error_reserve_price"></div>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between">                                       
                                        <button type="button" class="btn btn-primary next-step" data-next="step2">Next</button>
                                    </div>
                                </fieldset>                           
                                <fieldset id="step2" class="tab-pane ">
                                    <div class="row">                                        
                                        <!-- YouTube URL -->
                                        <div class="col-md-12 form-group">
                                            <label for="youtube_url">YouTube URL</label>
                                            <input id="youtube_url" class="form-control" name="youtube_url" type="url" placeholder="YouTube Video URL" value="{{ inventory_item.youtube_url|default:'' }}">
                                            <div class="text-danger" id="error_youtube_url"></div>
                                        </div>
                                        </form>
                                        <div class="col-md-12 form-group">
                                            <div class="alert" id="uploadAlert" role="alert" style="display:none;">
                                            </div>
                                            <form action="{% url 'upload_images' inventory_item.id %}" method="post" class="dropzone" id="imageDropzone">
                                                {% csrf_token %}
                                                <div class="fallback">
                                                    <input name="files" type="file" multiple />
                                                </div>

                                                <div class="dz-message needsclick">
                                                    <i class="h1 text-muted dripicons-cloud-upload"></i>
                                                    <h3>Drop files here or click to upload.</h3>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                
                                    <div class="d-flex justify-content-between">
                                        <button type="button" class="btn btn-secondary prev-step" data-prev="step1">Previous</button>
                                    </div>
                                </fieldset>
                            </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="{% static 'admin/js/dropzone.min.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js" ></script>
<script src="https://cdn.ckeditor.com/ckeditor5/34.0.0/classic/ckeditor.js"></script>
<script>
    function showStep(step) {
        $('.tab-pane').removeClass('show active').filter('#' + step).addClass('show active');
        $('.nav-link').removeClass('active').filter('a[href="#' + step + '"]').addClass('active');
        updateButtonStates(step);
    }

    function updateButtonStates(step) {
        $('.btn-secondary').prop('disabled', step === 'step1');
        $('.btn-primary.next-step').toggle(step !== 'step3');
    }

    function getQueryParam(param) {
        return new URLSearchParams(window.location.search).get(param);
    }

    $(document).ready(function() {
        const step = getQueryParam('step') ? 'step' + getQueryParam('step') : 'step1';
        showStep(step);

        $('.next-step').click(function() {
            showStep($(this).data('next'));
        });

        $('.prev-step').click(function() {
            showStep($(this).data('prev'));
        });

        $('.nav-link').click(function() {
            showStep($(this).attr('href').substring(1));
        });
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
<script>
    function updateImageOrder() {
        var newOrder = [];
        $('#imageDropzone .dz-preview').each(function(index) {
            var fileId = $(this).data('id') || $(this).find('.dz-filename span').text();
            newOrder.push(fileId);
        });

        $.ajax({
            url: '{% url "update_image_order" inventory_item.id %}',
            type: 'POST',
            data: JSON.stringify({ order: newOrder }),
            contentType: 'application/json',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            success: function(response) {
                console.log('Order updated successfully:', response);
            },
            error: function(xhr, status, error) {
                console.error('Error updating order:', error);
            }
        });
    }

    // Initialize sortable outside of Dropzone options
    $(document).ready(function() {
        var el = document.getElementById('imageDropzone');
        var sortable = Sortable.create(el, {
            animation: 150,
            ghostClass: 'blue-background-class',
            onEnd: function (evt) {
                updateImageOrder();
            },
        });
    });
    $(document).ready(function() {
        // Initialize CKEditor #####################################################################
        ClassicEditor
            .create(document.querySelector('#editor'), {
                toolbar: [
                    'heading',
                    '|',
                    'bold',
                    'italic',
                    'blockQuote',
                    'insertTable',
                    'undo',
                    'redo'
                ],
            })
            .catch(error => {
                console.error(error);
            });
        //#######################################################
         // On change event for status dropdown
        function toggleStatusFields() {
            var status = $('#status').val();
            if (status === 'in_transit') {
                $('#inTransitStatusDiv').show();
                $('.auctionDiv').hide();
            } else if (status === 'auction') {
                $('#inTransitStatusDiv').hide();
                $('.auctionDiv').show();
            } else {
                $('#inTransitStatusDiv').hide();
                $('.auctionDiv').hide();
            }
        }       
        $('#status').change(function() {
            toggleStatusFields();
        });
        // Call the function on page load to ensure correct visibility
        toggleStatusFields();
        //#####################################################################
        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }     

        $('#nextStep').click(function() {
            $('.text-danger').text('')
            $('.alert-success').text('')
            var isValid = true;
            var reservePrice = $("#reserve_price").val(); 

            reservePrice = reservePrice.replace(/,/g, ''); 

            if (reservePrice === '' || isNaN(reservePrice)) {
                $("#error_reserve_price").text("Please enter a valid reserve price.");
                isValid = false;
            } else {
                $("#error_reserve_price").text(""); 
            }
            var step1Form = $('#commentForm')[0];            
            var formData = new FormData(step1Form);
            $.ajax({
                type: "POST",
                url: step1Form.action,
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        $('.FinalUpdate').text('Inventory updated successfully.').fadeIn(); 
                        setTimeout(function() {
                            window.location.href = "{% url 'allinventory' 1 %}"; // Change this URL as needed
                        }, 3000);                        
                    } else {
                        $.each(response.errors, function(key, value) {
                            $("#error_" + key).text(value[0]); 
                        });
                    }
                },
                error: function(response) {
                }
            });
        });
    });
</script>
<script>
    Dropzone.options.imageDropzone = {
        paramName: "files", // The name that will be used to transfer the files
        maxFilesize: 10024, // MB
        acceptedFiles: ".jpeg,.jpg,.png,.gif,.webp,.svg",
       
        addRemoveLinks: true,
        autoProcessQueue: true, // Automatically process the queue as soon as files are added
        dictRemoveFile: "<i class='fa fa-times'></i>",
        dictCancelUpload: "<i class='fa fa-times'></i>",
        init: function() {
            const existingFiles = [
                {% for image in images %}
                {
                    id: "{{ image.id }}",
                    name: "{{ image.name }}",
                    size: '{{image.size}}',
                    url: "{{ MEDIA_URL }}{{ image.path|escapejs }}".replace(/\\/g, '/')
                },
                {% endfor %}
            ];

            for (let i = 0; i < existingFiles.length; i++) {
                const file = existingFiles[i];
                this.emit("addedfile", file);
                this.emit("thumbnail", file, file.url);
                this.emit("complete", file);
                this.files.push(file);
            }

            this.on("sending", function(file, xhr, formData) {
                formData.append("csrfmiddlewaretoken", "{{ csrf_token }}"); // Append the CSRF token to the form data
            });
            this.on("success", function(file, response) {
                $('#uploadAlert').removeClass('alert-danger').addClass('alert-success').text("File uploaded successfully").show();
                //console.log("File uploaded successfully:", response);
            });
            this.on("error", function(file, response) {
                $('#uploadAlert').removeClass('alert-success').addClass('alert-danger').text("File upload error: " + response).show();
                //console.error("File upload error:", response);
            });
            this.on("removedfile", function(file) {
                if (file.url) {
                    // Handle server-side file deletion if necessary
                    $.ajax({
                        url: "{% url 'delete_image' inventory_item.id %}",
                        type: "POST",
                        data: {
                            csrfmiddlewaretoken: "{{ csrf_token }}",
                            filename: file.name
                        },
                        success: function(response) {
                            $('#uploadAlert').removeClass('alert-danger').addClass('alert-success').text("File removed successfully").show();
                            console.log("File removed successfully:", response);
                        },
                        error: function(response) {
                            $('#uploadAlert').removeClass('alert-success').addClass('alert-danger').text("File removal error: " + response).show();
                            console.error("File removal error:", response);
                        }
                    });
                }
            });
            this.on("addedfile", function(file) {
                var fileType = file.type;
                var validFileTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp', 'image/svg+xml'];
                if (!validFileTypes.includes(fileType)) {
                    this.removeFile(file);
                    $('#uploadAlert').removeClass('alert-success').addClass('alert-danger').text("Invalid file type. Please upload only image files (jpeg, jpg, png, gif, webp, svg).").show();
                }
            });
            var el = document.getElementById('imageDropzone');
            var sortable = Sortable.create(el, {
                animation: 150,
                ghostClass: 'blue-background-class',
                onEnd: function (/**Event*/evt) {
                    var itemEl = evt.item;  // dragged HTMLElement
                    evt.to;    // target list
                    evt.from;  // previous list
                    evt.oldIndex;  // element's old index within old parent
                    evt.newIndex;  // element's new index within new parent
                    evt.oldDraggableIndex; // element's old index within old parent, only counting draggable elements
                    evt.newDraggableIndex; // element's new index within new parent, only counting draggable elements
                    evt.clone // the clone element
                    evt.pullMode;  // when item is in another sortable: `"clone"` if cloning, `true` if moving

                    // Update order on server
                    updateImageOrder();
                },
            });
        }
    };
    
</script>
{% endblock %}
