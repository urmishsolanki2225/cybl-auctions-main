{% extends 'layouts/default.html' %}
{% load static %}
{% block content %}
<script src="{% static 'admin-custom/payment.js' %}"></script>
<div class="container-fluid">
    <div class="row">
        <div class="col-xl-12 box-margin">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="card-title mb-0">
                            <i class="fa fa-edit text-warning mr-2"></i>
                            Edit Payment History #{{ payment.id }}
                        </h4>
                        <div>
                            <a href="{% url 'payment_invoice' payment.id %}" class="btn btn-info mr-2">
                                <i class="fa fa-file-invoice"></i> View Invoice
                            </a>
                            <a href="{% url 'payment_history' 1 %}" class="btn btn-secondary">
                                <i class="fa fa-arrow-left"></i> Back to List
                            </a>
                        </div>
                    </div>
                    
                    <!-- Payment Overview Card -->
                    <div class="alert alert-info mb-4">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <h6 class="mb-1">Current Status</h6>
                                {% if payment.status == 'Pending' %}
                                    <span class="badge badge-warning badge-lg">{{ payment.status }}</span>
                                {% elif payment.status == 'Completed' %}
                                    <span class="badge badge-success badge-lg">{{ payment.status }}</span>
                                {% elif payment.status == 'Failed' %}
                                    <span class="badge badge-danger badge-lg">{{ payment.status }}</span>
                                {% elif payment.status == 'Refunded' %}
                                    <span class="badge badge-info badge-lg">{{ payment.status }}</span>
                                {% endif %}
                            </div>
                            <div class="col-md-3">
                                <h6 class="mb-1">Amount</h6>
                                <strong class="h5 text-primary">${{ payment.amount|floatformat:2 }}</strong>
                            </div>
                            <div class="col-md-3">
                                <h6 class="mb-1">Created</h6>
                                <span>{{ payment.created_at|date:"M d, Y h:i A" }}</span>
                            </div>
                            <div class="col-md-3">
                                <h6 class="mb-1">Last Updated</h6>
                                <span>{{ payment.updated_at|date:"M d, Y h:i A" }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <form id="editPaymentForm" method="POST" action="{% url 'editpaymenthistory' payment.id %}">
                        {% csrf_token %}
                        
                        <!-- ==================== -->
                        <!-- Payment Information -->
                        <!-- ==================== -->
                        <fieldset>
                            <legend><i class="fa fa-credit-card mr-2"></i>Payment Information</legend>
                            <div class="row">
                                <!-- Transaction ID -->
                                <div class="col-md-6 form-group">
                                    <label for="transaction_id">Transaction ID</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text"><i class="fa fa-hashtag"></i></span>
                                        </div>
                                        <input id="transaction_id" class="form-control" name="transaction_id" 
                                               type="text" placeholder="Enter Transaction ID" 
                                               value="{{ payment.transaction_id|default:'' }}">
                                    </div>
                                    <div class="text-danger" id="error_transaction_id"></div>
                                </div>

                                <!-- Amount -->
                                <div class="col-md-6 form-group">
                                    <label for="amount">Amount<span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text"><i class="fa fa-dollar-sign"></i></span>
                                        </div>
                                        <input id="amount" class="form-control" name="amount" 
                                               type="number" step="0.01" min="0.01" 
                                               placeholder="Enter Amount" 
                                               value="{{ payment.amount|floatformat:2 }}">
                                    </div>
                                    <div class="text-danger" id="error_amount"></div>
                                </div>

                                <!-- User -->
                                <div class="col-md-6 form-group">
                                    <label for="user">User<span class="text-danger">*</span></label>
                                    <select id="user" class="form-control" name="user">
                                        <option value="">Select User</option>
                                        {% for user in users %}
                                            <option value="{{ user.id }}" 
                                                {% if payment.user.id == user.id %}selected{% endif %}>
                                                {{ user.username }} 
                                                {% if user.first_name or user.last_name %}
                                                    ({{ user.first_name }} {{ user.last_name }})
                                                {% endif %}
                                                - {{ user.email }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <div class="text-danger" id="error_user"></div>
                                </div>

                                <!-- Inventory -->
                                <div class="col-md-6 form-group">
                                    <label for="inventory">Inventory<span class="text-danger">*</span></label>
                                    <select id="inventory" class="form-control" name="inventory">
                                        <option value="">Select Inventory</option>
                                        {% for inventory in inventories %}
                                            <option value="{{ inventory.id }}" 
                                                {% if payment.inventory.id == inventory.id %}selected{% endif %}>
                                                [ID: {{ inventory.id }}] {{ inventory.title|truncatechars:50 }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <div class="text-danger" id="error_inventory"></div>
                                </div>

                                <!-- Status -->
                                <div class="col-md-6 form-group">
                                    <label for="status">Payment Status<span class="text-danger">*</span></label>
                                    <select id="status" class="form-control" name="status">
                                        <option value="">Select Status</option>
                                        <option value="Pending" {% if payment.status == "Pending" %}selected{% endif %}>Pending</option>
                                        <option value="Completed" {% if payment.status == "Completed" %}selected{% endif %}>Completed</option>
                                        <option value="Failed" {% if payment.status == "Failed" %}selected{% endif %}>Failed</option>
                                        <option value="Refunded" {% if payment.status == "Refunded" %}selected{% endif %}>Refunded</option>
                                    </select>
                                    <div class="text-danger" id="error_status"></div>
                                </div>

                                <!-- Payment Method -->
                                <div class="col-md-6 form-group">
                                    <label for="payment_method">Payment Method<span class="text-danger">*</span></label>
                                    <select id="payment_method" class="form-control" name="payment_method">
                                        <option value="">Select Payment Method</option>
                                        <option value="Online" {% if payment.payment_method == "Online" %}selected{% endif %}>Online Payment</option>
                                        <option value="Offline" {% if payment.payment_method == "Offline" %}selected{% endif %}>Offline Payment</option>
                                    </select>
                                    <div class="text-danger" id="error_payment_method"></div>
                                </div>
                            </div>
                        </fieldset>
                        
                        <!-- ==================== -->
                        <!-- Audit Information -->
                        <!-- ==================== -->
                        <fieldset>
                            <legend><i class="fa fa-history mr-2"></i>Audit Information</legend>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Payment ID</label>
                                        <input type="text" class="form-control" value="{{ payment.id }}" readonly>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Created Date</label>
                                        <input type="text" class="form-control" 
                                               value="{{ payment.created_at|date:'M d, Y h:i A' }}" readonly>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Last Modified</label>
                                        <input type="text" class="form-control" 
                                               value="{{ payment.updated_at|date:'M d, Y h:i A' }}" readonly>
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                        
                        <!-- Submit Buttons -->
                        <div class="form-group">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fa fa-save"></i> Update Payment Record
                                    </button>
                                    {% if payment.status == 'Pending' %}
                                        <button type="button" class="btn btn-success ml-2" onclick="quickStatusUpdate('Completed')">
                                            <i class="fa fa-check"></i> Mark as Completed
                                        </button>
                                        <button type="button" class="btn btn-danger ml-2" onclick="quickStatusUpdate('Failed')">
                                            <i class="fa fa-times"></i> Mark as Failed
                                        </button>
                                    {% endif %}
                                </div>  
                                
                            </div>
                        </div>
                        
                        <!-- General Error Display -->
                        <div class="text-danger" id="error_general"></div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    $("#editPaymentForm").on("submit", function(event) {
        event.preventDefault();
        
        // Clear previous errors
        $(".text-danger").text("");
        
        // Show loading state
        var submitBtn = $(this).find('button[type="submit"]');
        var originalText = submitBtn.html();
        submitBtn.html('<i class="fa fa-spinner fa-spin"></i> Updating...').prop('disabled', true);
        
        var formData = new FormData(this);
        
        $.ajax({
            url: $(this).attr("action"),
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
            },
            success: function(response) {
                if(response.success) {
                    showToast("success", response.message);
                    // Redirect to payment history list after 2 seconds
                    setTimeout(function() {
                        window.location.href = "{% url 'payment_history' 1 %}";
                    }, 2000);
                } else {
                    const errors = response.errors;
                    for (const key in errors) {
                        $("#error_" + key).text(errors[key].join(", "));
                    }
                    submitBtn.html(originalText).prop('disabled', false);
                }
            },
            error: function(xhr, status, error) {
                showToast("error", "An error occurred. Please try again.");
                submitBtn.html(originalText).prop('disabled', false);
            }
        });
    });
    
    // Real-time validation
    $("#amount").on("input", function() {
        var amount = parseFloat($(this).val());
        if (isNaN(amount) || amount <= 0) {
            $("#error_amount").text("Please enter a valid amount greater than 0");
        } else {
            $("#error_amount").text("");
        }
    });
    
    // Clear errors on field change
    $("select, input").on("change input", function() {
        var fieldName = $(this).attr("name");
        if ($(this).val()) {
            $("#error_" + fieldName).text("");
        }
    });
    
    // Status change confirmation
    $("#status").on("change", function() {
        var newStatus = $(this).val();
        var currentStatus = "{{ payment.status }}";
        
        if (newStatus !== currentStatus && newStatus !== "") {
            if (newStatus === "Refunded" || newStatus === "Failed") {
                if (!confirm("Are you sure you want to change the status to " + newStatus + "? This action should be carefully considered.")) {
                    $(this).val(currentStatus);
                    return;
                }
            }
        }
    });
});

// Quick status update function
function quickStatusUpdate(newStatus) {
    if (confirm("Are you sure you want to mark this payment as " + newStatus + "?")) {
        $("#status").val(newStatus);
        $("#editPaymentForm").submit();
    }
}

// Toast notification function
function showToast(type, message) {
    // Create toast element
    var toastClass = type === 'success' ? 'alert-success' : 'alert-danger';
    var icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
    
    var toast = $('<div class="alert ' + toastClass + ' alert-dismissible fade show position-fixed" style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">' +
        '<i class="fa ' + icon + ' mr-2"></i>' + message +
        '<button type="button" class="close" data-dismiss="alert">' +
        '<span>&times;</span>' +
        '</button>' +
        '</div>');
    
    $('body').append(toast);
    
    // Auto remove after 5 seconds
    setTimeout(function() {
        toast.fadeOut(function() {
            $(this).remove();
        });
    }, 5000);
}
</script>
{% endblock %}